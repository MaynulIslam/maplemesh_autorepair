<!--
=========================================================
* MapleMesh AutoRepair Dashboard - v2.1.0
=========================================================
* Last Updated: July 28, 2025
* Developed by MapleMesh Development Team
=========================================================
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>MapleMesh AutoRepair - Technician Profile</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link href="../assets/custom/css/style.css" rel="stylesheet" />
  </head>

  <body class="bg-gray-100">
    <!-- ===================== HEADER / NAVIGATION BAR ===================== -->
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
          <!-- Brand -->
          <a
            class="navbar-brand fw-bold me-3 d-flex flex-column align-items-start p-0"
            href="technician_dashboard.html"
          >
            <span>MapleMesh</span>
            <span>AutoRepair</span>
          </a>

          <!-- Left-side Navigation Links -->
          <div class="navbar-nav d-none d-lg-flex me-auto">
            <a class="nav-link fw-bold" href="technician_dashboard.html"
              >Dashboard</a
            >
            <a class="nav-link fw-bold" href="technician_jobs.html">Jobs</a>
            <a class="nav-link fw-bold" href="technician_schedule.html"
              >Schedule</a
            >
          </div>

          <!-- Welcome Message (Center) -->
          <div
            class="navbar-text d-none d-lg-block mx-auto text-center text-white"
          >
            <h4 class="mb-0 fw-bold">Professional Profile</h4>
            <small>Manage Your Service Information</small>
          </div>

          <!-- Right-side Navigation Links -->
          <div class="collapse navbar-collapse flex-grow-0" id="mainNavbar">
            <ul class="navbar-nav align-items-center">
              <li class="nav-item dropdown hover-dropdown">
                <a
                  class="nav-link fw-bold active"
                  href="technician_profile.html"
                  id="profileLink"
                  >Profile</a
                >
                <div
                  class="dropdown-menu dropdown-menu-end"
                  aria-labelledby="profileLink"
                >
                  <div class="dropdown-header d-flex align-items-center p-3">
                    <div class="avatar-circle me-3">
                      <img
                        src="../assets/img/avatar-placeholder.jpg"
                        alt="Profile"
                        class="avatar-img"
                      />
                    </div>
                    <div>
                      <h6 class="mb-0">Robert Jones</h6>
                      <small class="text-muted">ID: 234-631</small>
                    </div>
                  </div>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="technician_profile.html">
                    <i class="fas fa-user me-2 text-primary"></i>My Profile
                  </a>
                  <a class="dropdown-item" href="technician_wallet.html">
                    <i class="fas fa-wallet me-2 text-primary"></i>Wallet
                  </a>
                  <a class="dropdown-item" href="technician_jobs.html">
                    <i class="fas fa-history me-2 text-primary"></i>Job History
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-question-circle me-2 text-primary"></i>Help
                    & Support
                  </a>
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-sign-out-alt me-2 text-danger"></i>Sign Out
                  </a>
                </div>
              </li>
            </ul>
          </div>

          <!-- Mobile Toggle Button -->
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNavbar"
            aria-controls="mainNavbar"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </nav>
    </header>
    <!-- ===================== END HEADER / NAVIGATION BAR ===================== -->

    <!-- Tab Navigation -->
    <div class="content-wrapper">
      <div class="container-fluid py-3">
        <ul
          class="nav nav-tabs justify-content-center mb-4"
          id="profileTabs"
          role="tablist"
        >
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="dashboard-tab"
              data-bs-toggle="tab"
              data-bs-target="#dashboard"
              type="button"
              role="tab"
              onclick="location.href='technician_dashboard.html'"
            >
              Dashboard
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="appointment-tab"
              data-bs-toggle="tab"
              data-bs-target="#appointment"
              type="button"
              role="tab"
              onclick="location.href='technician_jobs.html'"
            >
              Appointment
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="earnings-tab"
              data-bs-toggle="tab"
              data-bs-target="#earnings"
              type="button"
              role="tab"
              onclick="location.href='technician_wallet.html'"
            >
              Earnings
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="profile-tab"
              data-bs-toggle="tab"
              data-bs-target="#profile"
              type="button"
              role="tab"
            >
              Profile
            </button>
          </li>
        </ul>

        <!-- Profile Content -->
        <div class="row g-4">
          <!-- Left Side - Profile Info -->
          <div class="col-md-4">
            <div class="card mb-4">
              <div class="card-body text-center">
                <div
                  class="avatar-circle mx-auto mb-3"
                  style="width: 120px; height: 120px"
                >
                  <img
                    src="../assets/img/avatar-placeholder.jpg"
                    alt="Profile"
                    class="avatar-img"
                  />
                </div>
                <h5 class="mb-1">Robert Jones</h5>
                <p class="text-muted mb-2">ID: 234-631</p>
                <div
                  class="d-flex justify-content-center align-items-center mb-3"
                >
                  <span class="badge bg-success me-2">
                    <i class="fas fa-check-circle me-1"></i>Verified by mothers
                  </span>
                  <div class="verification-icons">
                    <i
                      class="fas fa-envelope text-primary me-2"
                      title="Email Verified"
                    ></i>
                    <i
                      class="fas fa-phone text-primary"
                      title="Phone Verified"
                    ></i>
                  </div>
                </div>
                <button class="btn btn-primary w-100">Edit Profile</button>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="card">
              <div class="card-body">
                <h6 class="text-primary mb-3">Contact Information</h6>
                <div class="mb-3">
                  <strong>Full Name</strong><br />
                  <span class="text-muted">Robert Jones</span>
                </div>
                <div class="mb-3">
                  <strong>Email Address</strong><br />
                  <span class="text-muted">eng@gmai.com</span>
                </div>
                <div class="mb-3">
                  <strong>Phone</strong><br />
                  <span class="text-muted">706-xxx-xxxx</span>
                </div>
                <div class="mb-3">
                  <strong>Current Employer</strong><br />
                  <span class="text-muted">Mr Fixer</span>
                </div>
                <div class="mb-0">
                  <strong>Availability</strong><br />
                  <span class="text-muted">Part-time</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Side - Skills and Certificates -->
          <div class="col-md-8">
            <!-- Certified Skills -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Certified Skills</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <!-- Tire Change -->
                    <div class="skill-item mb-3">
                      <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-tire text-primary me-2"></i>
                        <span class="fw-medium">Tire Change</span>
                      </div>
                      <div class="star-rating">
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                      </div>
                    </div>

                    <!-- Brake Shoe Repair -->
                    <div class="skill-item mb-3">
                      <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-brake text-primary me-2"></i>
                        <span class="fw-medium">Brake shoe repair</span>
                      </div>
                      <div class="star-rating">
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="far fa-star text-muted"></i>
                        <i class="far fa-star text-muted"></i>
                      </div>
                    </div>

                    <!-- Dent Fixing -->
                    <div class="skill-item mb-3">
                      <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-hammer text-primary me-2"></i>
                        <span class="fw-medium">Dent fixing</span>
                      </div>
                      <div class="star-rating">
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="far fa-star text-muted"></i>
                        <i class="far fa-star text-muted"></i>
                      </div>
                    </div>

                    <!-- Deep Cleaning -->
                    <div class="skill-item mb-3">
                      <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-spray-can text-primary me-2"></i>
                        <span class="fw-medium">Deep cleaning</span>
                      </div>
                      <div class="star-rating">
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="far fa-star text-muted"></i>
                      </div>
                    </div>

                    <!-- Tire Pump -->
                    <div class="skill-item mb-3">
                      <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-air-pump text-primary me-2"></i>
                        <span class="fw-medium">Tire pump</span>
                      </div>
                      <div class="star-rating">
                        <i class="fas fa-star text-warning"></i>
                        <i class="fas fa-star text-warning"></i>
                        <i class="far fa-star text-muted"></i>
                        <i class="far fa-star text-muted"></i>
                        <i class="far fa-star text-muted"></i>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <!-- Certificates & Experience -->
                    <div class="certificates-section">
                      <h6 class="text-primary mb-3">
                        Present Certificates & Experience
                      </h6>

                      <div
                        class="certificate-item d-flex align-items-center mb-3"
                      >
                        <div class="certificate-icon me-3">
                          <i class="fas fa-certificate text-warning"></i>
                        </div>
                        <div>
                          <div class="fw-medium">
                            (i) 2 Years with Canadian Tire
                          </div>
                        </div>
                      </div>

                      <div
                        class="certificate-item d-flex align-items-center mb-3"
                      >
                        <div class="certificate-icon me-3">
                          <i class="fas fa-certificate text-warning"></i>
                        </div>
                        <div>
                          <div class="fw-medium">
                            (ii) Machine Safety Essentials
                          </div>
                        </div>
                      </div>

                      <div
                        class="certificate-item d-flex align-items-center mb-3"
                      >
                        <div class="certificate-icon me-3">
                          <i class="fas fa-certificate text-warning"></i>
                        </div>
                        <div>
                          <div class="fw-medium">
                            (iii) High pressure cleaning
                          </div>
                        </div>
                      </div>

                      <div
                        class="certificate-item d-flex align-items-center mb-3"
                      >
                        <div class="certificate-icon me-3">
                          <i class="fas fa-certificate text-warning"></i>
                        </div>
                        <div>
                          <div class="fw-medium">(iv) Customer handling</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Add New Skill Button -->
                <div class="text-center mt-4">
                  <button class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Request for add new
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
      let technicianProfile = null;

      document.addEventListener("DOMContentLoaded", function () {
        loadTechnicianProfile();
        bindEventListeners();
      });

      async function loadTechnicianProfile() {
        try {
          const token = localStorage.getItem("access_token");
          if (!token) {
            window.location.href = "sign-in.html";
            return;
          }

          const response = await fetch(
            "http://localhost:8001/api/technician/profile",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (response.ok) {
            technicianProfile = await response.json();
            populateProfileData();
          } else {
            throw new Error("Failed to load profile");
          }
        } catch (error) {
          console.error("Error loading profile:", error);
          alert("Failed to load profile data. Please try again.");
        }
      }

      function populateProfileData() {
        if (!technicianProfile) return;

        // Update header dropdown
        document.getElementById(
          "tech-name"
        ).textContent = `${technicianProfile.first_name} ${technicianProfile.last_name}`;
        document.getElementById(
          "tech-id"
        ).textContent = `ID: ${technicianProfile.technician_id}`;

        // Update profile card
        const profileCard = document.querySelector(".card-body.text-center");
        profileCard.querySelector(
          "h5"
        ).textContent = `${technicianProfile.first_name} ${technicianProfile.last_name}`;
        profileCard.querySelector(
          "p.text-muted"
        ).textContent = `ID: ${technicianProfile.technician_id}`;

        // Update verification status
        const verificationBadge = profileCard.querySelector(".badge");
        if (technicianProfile.is_verified) {
          verificationBadge.innerHTML =
            '<i class="fas fa-check-circle me-1"></i>Verified Professional';
          verificationBadge.className = "badge bg-success me-2";
        } else {
          verificationBadge.innerHTML =
            '<i class="fas fa-clock me-1"></i>Pending Verification';
          verificationBadge.className = "badge bg-warning me-2";
        }

        // Update contact information
        updateContactInformation();

        // Update skills and certifications
        updateSkillsAndCertifications();
      }

      function updateContactInformation() {
        const contactInfo = document.querySelector(
          ".card:last-child .card-body"
        );

        contactInfo.innerHTML = `
          <h6 class="text-primary mb-3">Contact Information</h6>
          <div class="mb-3">
            <strong>Full Name</strong><br>
            <span class="text-muted">${technicianProfile.first_name} ${technicianProfile.last_name}</span>
          </div>
          <div class="mb-3">
            <strong>Email Address</strong><br>
            <span class="text-muted">${technicianProfile.email}</span>
          </div>
          <div class="mb-3">
            <strong>Phone</strong><br>
            <span class="text-muted">${technicianProfile.phone}</span>
          </div>
          <div class="mb-3">
            <strong>Business Name</strong><br>
            <span class="text-muted">${technicianProfile.business_name}</span>
          </div>
          <div class="mb-3">
            <strong>Experience</strong><br>
            <span class="text-muted">${technicianProfile.years_experience} years</span>
          </div>
          <div class="mb-3">
            <strong>Service Radius</strong><br>
            <span class="text-muted">${technicianProfile.service_radius} km</span>
          </div>
          <div class="mb-0">
            <strong>Location</strong><br>
            <span class="text-muted">${technicianProfile.city}, ${technicianProfile.province}</span>
          </div>
        `;
      }

      function updateSkillsAndCertifications() {
        const skillsContainer = document.querySelector(".col-md-6:first-child");
        const certificatesContainer = document.querySelector(
          ".col-md-6:last-child"
        );

        // Update skills section
        const skillsHTML = technicianProfile.areas_of_expertise
          .map((skill) => {
            const skillName = formatSkillName(skill);
            const rating = getSkillRating(skill);

            return `
            <div class="skill-item mb-3">
              <div class="d-flex align-items-center mb-2">
                <i class="fas ${getSkillIcon(skill)} text-primary me-2"></i>
                <span class="fw-medium">${skillName}</span>
              </div>
              <div class="star-rating">
                ${generateStarRating(rating)}
              </div>
            </div>
          `;
          })
          .join("");

        skillsContainer.innerHTML = skillsHTML;

        // Update certificates section
        let certificatesHTML = `
          <h6 class="text-primary mb-3">Professional Information</h6>
          <div class="mb-3">
            <strong>Years of Experience:</strong><br>
            <span class="text-muted">${technicianProfile.years_experience} years</span>
          </div>
        `;

        if (
          technicianProfile.is_certified &&
          technicianProfile.certification_details
        ) {
          certificatesHTML += `
            <div class="certificate-item d-flex align-items-center mb-3">
              <div class="certificate-icon me-3">
                <i class="fas fa-certificate text-warning"></i>
              </div>
              <div>
                <div class="fw-medium">Certified Professional</div>
                <small class="text-muted">${
                  technicianProfile.certification_details
                    .certification_authority
                }</small>
              </div>
            </div>
            <div class="certificate-item d-flex align-items-center mb-3">
              <div class="certificate-icon me-3">
                <i class="fas fa-id-card text-primary"></i>
              </div>
              <div>
                <div class="fw-medium">Certification #${
                  technicianProfile.certification_details.certification_number
                }</div>
                <small class="text-muted">Expires: ${new Date(
                  technicianProfile.certification_details.certification_expiry
                ).toLocaleDateString()}</small>
              </div>
            </div>
          `;
        } else {
          certificatesHTML += `
            <div class="certificate-item d-flex align-items-center mb-3">
              <div class="certificate-icon me-3">
                <i class="fas fa-user text-secondary"></i>
              </div>
              <div>
                <div class="fw-medium">Non-Certified Technician</div>
                <small class="text-muted">Professional experience based</small>
              </div>
            </div>
          `;
        }

        certificatesContainer.innerHTML = certificatesHTML;
      }

      function formatSkillName(skill) {
        const skillMap = {
          engine_repair: "Engine Repair",
          brake_repair: "Brake Repair",
          transmission: "Transmission",
          electrical: "Electrical Systems",
          ac_heating: "A/C & Heating",
          tire_service: "Tire Services",
          suspension: "Suspension & Steering",
          diagnostics: "Computer Diagnostics",
          oil_change: "Oil Change & Maintenance",
          bodywork: "Body Work",
          painting: "Painting",
          glass: "Glass Repair/Replacement",
        };
        return (
          skillMap[skill] ||
          skill.replace(/_/g, " ").replace(/\b\w/g, (l) => l.toUpperCase())
        );
      }

      function getSkillIcon(skill) {
        const iconMap = {
          engine_repair: "fa-cog",
          brake_repair: "fa-stop-circle",
          transmission: "fa-cogs",
          electrical: "fa-bolt",
          ac_heating: "fa-thermometer-half",
          tire_service: "fa-circle",
          suspension: "fa-car",
          diagnostics: "fa-laptop",
          oil_change: "fa-oil-can",
          bodywork: "fa-hammer",
          painting: "fa-paint-brush",
          glass: "fa-window-maximize",
        };
        return iconMap[skill] || "fa-wrench";
      }

      function getSkillRating(skill) {
        // This would normally come from the database based on customer reviews
        // For now, we'll generate a random rating between 3-5 stars
        return Math.floor(Math.random() * 3) + 3;
      }

      function generateStarRating(rating) {
        let stars = "";
        for (let i = 1; i <= 5; i++) {
          if (i <= rating) {
            stars += '<i class="fas fa-star text-warning"></i>';
          } else {
            stars += '<i class="far fa-star text-muted"></i>';
          }
        }
        return stars;
      }

      function bindEventListeners() {
        // Edit profile button
        const editProfileBtn = document.querySelector(".btn-primary");
        if (
          editProfileBtn &&
          editProfileBtn.textContent.includes("Edit Profile")
        ) {
          editProfileBtn.addEventListener("click", function () {
            // Enable editing mode or redirect to edit page
            enableEditMode();
          });
        }

        // Request new skill button
        const addSkillBtn = document.querySelector(".btn-primary");
        if (
          addSkillBtn &&
          addSkillBtn.textContent.includes("Request for add new")
        ) {
          addSkillBtn.addEventListener("click", function () {
            requestNewSkill();
          });
        }
      }

      function enableEditMode() {
        // This would implement inline editing or redirect to an edit form
        alert(
          "Edit profile functionality will be implemented. For now, contact support to update your profile."
        );
      }

      async function requestNewSkill() {
        const skillName = prompt(
          "What new skill would you like to add to your profile?"
        );
        if (!skillName) return;

        try {
          const token = localStorage.getItem("access_token");
          const response = await fetch(
            "http://localhost:8001/api/technician/skill-request",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ skill_name: skillName }),
            }
          );

          if (response.ok) {
            alert(
              "Skill request submitted successfully! It will be reviewed by our team."
            );
          } else {
            throw new Error("Failed to submit skill request");
          }
        } catch (error) {
          console.error("Error submitting skill request:", error);
          alert("Failed to submit skill request. Please try again.");
        }
      }

      // Star rating interaction for future rating updates
      function initializeStarRatings() {
        const starRatings = document.querySelectorAll(".star-rating");
        starRatings.forEach((rating) => {
          const stars = rating.querySelectorAll("i");
          stars.forEach((star, index) => {
            star.addEventListener("mouseenter", function () {
              // Highlight stars on hover (for editing mode)
              if (rating.classList.contains("editable")) {
                for (let i = 0; i <= index; i++) {
                  stars[i].className = "fas fa-star text-warning";
                }
                for (let i = index + 1; i < stars.length; i++) {
                  stars[i].className = "far fa-star text-muted";
                }
              }
            });

            star.addEventListener("click", function () {
              if (rating.classList.contains("editable")) {
                // Handle rating update
                const newRating = index + 1;
                updateSkillRating(rating.dataset.skill, newRating);
              }
            });
          });
        });
      }

      async function updateSkillRating(skill, rating) {
        try {
          const token = localStorage.getItem("access_token");
          const response = await fetch(
            "http://localhost:8001/api/technician/skill-rating",
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ skill, rating }),
            }
          );

          if (response.ok) {
            alert("Skill rating updated successfully!");
            loadTechnicianProfile(); // Refresh the profile
          } else {
            throw new Error("Failed to update skill rating");
          }
        } catch (error) {
          console.error("Error updating skill rating:", error);
          alert("Failed to update skill rating. Please try again.");
        }
      }
    </script>
  </body>
</html>
