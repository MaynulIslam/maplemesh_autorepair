<!--
=========================================================
* MapleMesh AutoRepair Dashboard - v2.1.0
=========================================================
* Last Updated: July 28, 2025
* Developed by MapleMesh Development Team
=========================================================
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>MapleMesh AutoRepair - Technician Dashboard</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link href="../assets/custom/css/style.css" rel="stylesheet" />
  </head>

  <body class="bg-gray-100">
    <!-- ===================== HEADER / NAVIGATION BAR ===================== -->
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
          <!-- Brand -->
          <a
            class="navbar-brand fw-bold me-3 d-flex flex-column align-items-start p-0"
            href="technician_dashboard.html"
          >
            <span>MapleMesh</span>
            <span>AutoRepair</span>
          </a>

          <!-- Left-side Navigation Links -->
          <div class="navbar-nav d-none d-lg-flex me-auto">
            <a class="nav-link fw-bold active" href="technician_dashboard.html"
              >Dashboard</a
            >
            <a class="nav-link fw-bold" href="technician_jobs.html">Jobs</a>
            <a class="nav-link fw-bold" href="technician_schedule.html"
              >Schedule</a
            >
          </div>

          <!-- Welcome Message (Center) -->
          <div
            class="navbar-text d-none d-lg-block mx-auto text-center text-white"
          >
            <h4 class="mb-0 fw-bold">Welcome Back!</h4>
            <small>Your Professional Service Dashboard</small>
          </div>

          <!-- Right-side Navigation Links -->
          <div class="collapse navbar-collapse flex-grow-0" id="mainNavbar">
            <ul class="navbar-nav align-items-center">
              <li class="nav-item dropdown hover-dropdown">
                <a
                  class="nav-link fw-bold"
                  href="technician_profile.html"
                  id="profileLink"
                  >Profile</a
                >
                <div
                  class="dropdown-menu dropdown-menu-end"
                  aria-labelledby="profileLink"
                >
                  <div class="dropdown-header d-flex align-items-center p-3">
                    <div class="avatar-circle me-3">
                      <img
                        src="../assets/img/avatar-placeholder.jpg"
                        alt="Profile"
                        class="avatar-img"
                      />
                    </div>
                    <div>
                      <h6 class="mb-0">Technician Name</h6>
                      <small class="text-muted"
                        >Rating: 4.7/5 (120 reviews)</small
                      >
                    </div>
                  </div>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="technician_profile.html">
                    <i class="fas fa-user me-2 text-primary"></i>My Profile
                  </a>
                  <a class="dropdown-item" href="technician_jobs.html">
                    <i class="fas fa-history me-2 text-primary"></i>Job History
                  </a>
                  <a class="dropdown-item" href="technician_earnings.html">
                    <i class="fas fa-credit-card me-2 text-primary"></i>Earnings
                  </a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-question-circle me-2 text-primary"></i>Help
                    & Support
                  </a>
                  <a class="dropdown-item" href="#">
                    <i class="fas fa-sign-out-alt me-2 text-danger"></i>Sign Out
                  </a>
                </div>
              </li>
            </ul>
          </div>

          <!-- Mobile Toggle Button -->
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNavbar"
            aria-controls="mainNavbar"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </nav>
    </header>
    <!-- ===================== END HEADER / NAVIGATION BAR ===================== -->

    <!-- Main Content Container -->
    <div class="content-wrapper">
      <div class="container-fluid py-4">
        <!-- ===================== TOP STATS CARDS ROW ===================== -->
        <div class="row g-4 mb-4">
          <!-- Overview Box -->
          <div class="col-md-6 col-xl-4">
            <div class="card h-100" id="overview-card">
              <!-- Component will be rendered here -->
            </div>
          </div>

          <!-- Location & Skills Box -->
          <div class="col-md-6 col-xl-4">
            <div class="card h-100" id="location-skills-card">
              <!-- Component will be rendered here -->
            </div>
          </div>

          <!-- Quick Actions Box -->
          <div class="col-md-6 col-xl-4">
            <div class="card h-100" id="quick-actions-card">
              <div class="card-body">
                <h6 class="text-primary mb-3">Quick Actions</h6>
                <div class="d-grid gap-2">
                  <button class="btn btn-primary">
                    <i class="fas fa-check me-2"></i>Mark Job Complete
                  </button>
                  <button class="btn btn-light">
                    <i class="fas fa-clock me-2"></i>Update Availability
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- ===================== END TOP STATS CARDS ROW ===================== -->

        <!-- ===================== UPCOMING JOBS & AVAILABLE JOBS ROW ===================== -->
        <div class="row g-4 mb-4">
          <!-- Upcoming Jobs Box -->
          <div class="col-md-7">
            <div class="card" id="upcoming-jobs-card">
              <!-- Component will be rendered here -->
            </div>
          </div>

          <!-- Available Jobs Box -->
          <div class="col-md-5">
            <div class="card" id="available-jobs-card">
              <!-- Component will be rendered here -->
            </div>
          </div>
        </div>
        <!-- ===================== END UPCOMING JOBS & AVAILABLE JOBS ROW ===================== -->

        <!-- ===================== BOTTOM SECTION ===================== -->
        <div class="row g-4">
          <!-- Recent Activity Box -->
          <div class="col-md-7">
            <div class="card" id="recent-activity-card">
              <!-- Component will be rendered here -->
            </div>
          </div>

          <!-- Settings & Preferences Box -->
          <div class="col-md-5">
            <div id="preferences-box">
              <div id="location-preferences-card" class="mb-3">
                <!-- Component will be rendered here -->
              </div>
              <div id="skill-set-card">
                <!-- Component will be rendered here -->
              </div>
            </div>
          </div>
        </div>
        <!-- ===================== END BOTTOM SECTION ===================== -->
      </div>
    </div>
    <!-- ===================== END MAIN CONTENT ===================== -->

    <!-- Component Scripts -->
    <script src="../assets/js/components/base-component.js"></script>
    <script src="../assets/js/components/dashboard-card.js"></script>
    <script src="../assets/js/components/data-table.js"></script>
    <script src="../assets/js/components/checkbox-list.js"></script>
    <script src="../assets/js/components/job-listing.js"></script>
    <script src="../assets/js/components/activity-list.js"></script>
    <script src="../assets/js/dashboard-data.js"></script>
    <script src="../assets/js/dashboard-controller.js"></script>

    <!-- Bootstrap JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Initialize Dashboard -->
    <script>
      let technicianData = null;
      let jobsData = [];
      let availableJobsData = [];

      document.addEventListener("DOMContentLoaded", function () {
        loadTechnicianProfile();
        loadDashboardData();
        initializeDashboard();
      });

      async function loadTechnicianProfile() {
        try {
          const token = localStorage.getItem("access_token");
          if (!token) {
            console.log("No token found, showing demo data");
            showDemoTechnicianData();
            return;
          }

          const response = await fetch(
            "http://localhost:8001/api/technician/profile",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (response.ok) {
            technicianData = await response.json();
            updateTechnicianProfile();
          } else if (response.status === 401) {
            localStorage.removeItem("access_token");
            showDemoTechnicianData();
          } else {
            throw new Error("Failed to load technician profile");
          }
        } catch (error) {
          console.error("Error loading technician profile:", error);
          showDemoTechnicianData();
        }
      }

      async function loadDashboardData() {
        try {
          const token = localStorage.getItem("access_token");
          if (!token) {
            showDemoJobsData();
            return;
          }

          // Load upcoming jobs
          const jobsResponse = await fetch(
            "http://localhost:8001/api/technician/jobs?status=upcoming",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (jobsResponse.ok) {
            jobsData = await jobsResponse.json();
          }

          // Load available jobs
          const availableResponse = await fetch(
            "http://localhost:8001/api/technician/available-jobs",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (availableResponse.ok) {
            availableJobsData = await availableResponse.json();
          }

          updateDashboardComponents();
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showDemoJobsData();
        }
      }

      function showDemoTechnicianData() {
        technicianData = {
          first_name: "Alex",
          last_name: "Johnson",
          technician_id: "TECH-001",
          rating: 4.7,
          total_reviews: 120,
          current_status: "Available",
          years_experience: 5,
          areas_of_expertise: [
            "brake_repair",
            "oil_change",
            "engine_diagnostics",
          ],
          location_preferences: {
            max_distance: 25,
            garage_access_required: true,
          },
        };
        updateTechnicianProfile();
      }

      function showDemoJobsData() {
        jobsData = [
          {
            job_id: "JOB-001",
            customer_name: "John Smith",
            vehicle_make: "Ford",
            vehicle_model: "F-150",
            service_type: "Tire Rotation",
            scheduled_date: "2025-01-15",
            status: "scheduled",
            location: "123 Main St, Toronto",
          },
          {
            job_id: "JOB-002",
            customer_name: "Maria Lopez",
            vehicle_make: "Honda",
            vehicle_model: "Accord",
            service_type: "Oil Change",
            scheduled_date: "2025-01-16",
            status: "confirmed",
            location: "456 Oak Ave, Toronto",
          },
        ];

        availableJobsData = [
          {
            job_id: "AVAIL-001",
            customer_name: "Sarah Wilson",
            vehicle_make: "Nissan",
            vehicle_model: "Altima",
            service_type: "Engine Diagnostics",
            location: "5 km away",
            urgency: "medium",
            estimated_duration: "2 hours",
          },
          {
            job_id: "AVAIL-002",
            customer_name: "Michael Brown",
            vehicle_make: "BMW",
            vehicle_model: "X3",
            service_type: "Brake Replacement",
            location: "8 km away",
            urgency: "high",
            estimated_duration: "3 hours",
          },
        ];

        updateDashboardComponents();
      }

      function updateTechnicianProfile() {
        if (!technicianData) return;

        // Update header dropdown
        const profileHeader = document.querySelector(".dropdown-header h6");
        const profileSubtext = document.querySelector(".dropdown-header small");

        if (profileHeader) {
          profileHeader.textContent = `${technicianData.first_name} ${technicianData.last_name}`;
        }
        if (profileSubtext) {
          profileSubtext.textContent = `Rating: ${technicianData.rating}/5 (${technicianData.total_reviews} reviews)`;
        }
      }

      function updateDashboardComponents() {
        updateOverviewCard();
        updateLocationSkillsCard();
        updateUpcomingJobsCard();
        updateAvailableJobsCard();
        updateRecentActivityCard();
        updatePreferencesCards();
      }

      function updateOverviewCard() {
        const overviewCard = document.getElementById("overview-card");
        if (!overviewCard || !technicianData) return;

        overviewCard.innerHTML = `
        <div class="card-body">
          <h6 class="text-primary mb-3">Overview</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="technician-count mb-0">${technicianData.first_name} ${technicianData.last_name}</h4>
              <p class="stats-label mb-0">Technician</p>
            </div>
            <div class="text-end">
              <h4 class="technician-count text-warning mb-0">
                <i class="fas fa-star"></i> ${technicianData.rating}
              </h4>
              <p class="stats-label mb-0">${technicianData.total_reviews} reviews</p>
            </div>
          </div>
          <div class="mt-3">
            <span class="badge bg-success">
              <i class="fas fa-check-circle me-1"></i>${technicianData.current_status}
            </span>
          </div>
        </div>
      `;
      }

      function updateLocationSkillsCard() {
        const locationSkillsCard = document.getElementById(
          "location-skills-card"
        );
        if (!locationSkillsCard || !technicianData) return;

        const skillCount = technicianData.areas_of_expertise
          ? technicianData.areas_of_expertise.length
          : 0;
        const maxDistance = technicianData.location_preferences
          ? technicianData.location_preferences.max_distance
          : 25;

        locationSkillsCard.innerHTML = `
        <div class="card-body">
          <h6 class="text-primary mb-3">Location & Skills</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="technician-count mb-0">${maxDistance}km</h3>
              <p class="stats-label mb-0">Service Radius</p>
            </div>
            <div>
              <h3 class="technician-count text-primary mb-0">${skillCount}</h3>
              <p class="stats-label mb-0">Active Skills</p>
            </div>
          </div>
        </div>
      `;
      }

      function updateUpcomingJobsCard() {
        const upcomingJobsCard = document.getElementById("upcoming-jobs-card");
        if (!upcomingJobsCard) return;

        let tableContent = "";
        if (jobsData && jobsData.length > 0) {
          const tableRows = jobsData
            .map(
              (job) => `
          <tr>
            <td>${new Date(job.scheduled_date).toLocaleDateString()}</td>
            <td>${job.customer_name}</td>
            <td>${job.vehicle_make} ${job.vehicle_model}</td>
            <td>${job.service_type}</td>
            <td>
              <span class="badge bg-${getJobStatusColor(job.status)}">${
                job.status
              }</span>
            </td>
          </tr>
        `
            )
            .join("");

          tableContent = `
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Vehicle</th>
                  <th>Service Type</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
        } else {
          tableContent = `
          <div class="text-center py-4">
            <i class="fas fa-calendar-day fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">No upcoming jobs</h6>
            <p class="text-muted">Check available jobs to get started</p>
          </div>
        `;
        }

        upcomingJobsCard.innerHTML = `
        <div class="card-header">
          <h5 class="mb-0">Upcoming Jobs</h5>
        </div>
        <div class="card-body p-0">
          ${tableContent}
        </div>
      `;
      }

      function updateAvailableJobsCard() {
        const availableJobsCard = document.getElementById(
          "available-jobs-card"
        );
        if (!availableJobsCard) return;

        let content = "";
        if (availableJobsData && availableJobsData.length > 0) {
          const currentJob = availableJobsData[0]; // Show first available job
          content = `
          <div class="job-details mb-3">
            <div class="row">
              <div class="col-6">
                <strong>Vehicle:</strong><br>
                <span class="text-muted">${currentJob.vehicle_make} ${
            currentJob.vehicle_model
          }</span>
              </div>
              <div class="col-6">
                <strong>Service:</strong><br>
                <span class="text-muted">${currentJob.service_type}</span>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-6">
                <strong>Location:</strong><br>
                <span class="text-muted">${currentJob.location}</span>
              </div>
              <div class="col-6">
                <strong>Duration:</strong><br>
                <span class="text-muted">${currentJob.estimated_duration}</span>
              </div>
            </div>
          </div>
          <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3">
            <button class="btn btn-success btn-sm" onclick="acceptJob('${
              currentJob.job_id
            }')">
              <i class="fas fa-check me-1"></i>Accept
            </button>
            <button class="btn btn-danger btn-sm" onclick="declineJob('${
              currentJob.job_id
            }')">
              <i class="fas fa-times me-1"></i>Decline
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="viewJobDetails('${
              currentJob.job_id
            }')">
              <i class="fas fa-eye me-1"></i>View Details
            </button>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">Job 1 of ${
              availableJobsData.length
            }</small>
            <div class="btn-group">
              <button class="btn btn-outline-secondary btn-sm" onclick="previousJob()" ${
                availableJobsData.length <= 1 ? "disabled" : ""
              }>
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="nextJob()" ${
                availableJobsData.length <= 1 ? "disabled" : ""
              }>
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        `;
        } else {
          content = `
          <div class="text-center py-4">
            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
            <h6 class="text-muted">No available jobs</h6>
            <small class="text-muted">Check back later for new opportunities</small>
          </div>
        `;
        }

        availableJobsCard.innerHTML = `
        <div class="card-body">
          <h6 class="text-primary mb-3">Available Jobs</h6>
          ${content}
        </div>
      `;
      }

      function updateRecentActivityCard() {
        const recentActivityCard = document.getElementById(
          "recent-activity-card"
        );
        if (!recentActivityCard) return;

        const activities = [
          {
            status: "completed",
            description: "Completed brake repair - Honda Civic",
            time: "2 hours ago",
          },
          {
            status: "scheduled",
            description: "Scheduled oil change - Toyota Corolla",
            time: "4 hours ago",
          },
          {
            status: "pending",
            description: "Pending approval - Engine Diagnostics",
            time: "1 day ago",
          },
        ];

        const activityList = activities
          .map(
            (activity) => `
        <li class="d-flex justify-content-between align-items-center py-2">
          <div>
            <i class="fas fa-${getActivityIcon(
              activity.status
            )} me-2 text-${getActivityColor(activity.status)}"></i>
            ${activity.description}
          </div>
          <small class="text-muted">${activity.time}</small>
        </li>
      `
          )
          .join("");

        recentActivityCard.innerHTML = `
        <div class="card-header">
          <h5 class="mb-0">Recent Activity</h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            ${activityList}
          </ul>
        </div>
      `;
      }

      function updatePreferencesCards() {
        // Location Preferences
        const locationPreferencesCard = document.getElementById(
          "location-preferences-card"
        );
        if (locationPreferencesCard && technicianData) {
          const preferences = technicianData.location_preferences || {};
          locationPreferencesCard.innerHTML = `
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary mb-0">Location Preferences</h6>
                <button class="btn btn-outline-primary btn-sm">Edit</button>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" ${
                  preferences.max_distance ? "checked" : ""
                } disabled>
                <label class="form-check-label">Within ${
                  preferences.max_distance || 25
                } km</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" ${
                  preferences.garage_access_required ? "checked" : ""
                } disabled>
                <label class="form-check-label">Garage access required</label>
              </div>
            </div>
          </div>
        `;
        }

        // Skills Set
        const skillSetCard = document.getElementById("skill-set-card");
        if (skillSetCard && technicianData) {
          const skills = technicianData.areas_of_expertise || [];
          const skillItems = skills
            .map(
              (skill) => `
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" checked disabled>
            <label class="form-check-label">${formatSkillName(skill)}</label>
          </div>
        `
            )
            .join("");

          skillSetCard.innerHTML = `
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary mb-0">Skills & Services</h6>
                <button class="btn btn-outline-primary btn-sm">Edit</button>
              </div>
              ${skillItems}
              <button class="btn btn-primary btn-sm mt-2">
                <i class="fas fa-plus me-2"></i>Add More
              </button>
            </div>
          </div>
        `;
        }
      }

      // Helper functions
      function getJobStatusColor(status) {
        const colors = {
          scheduled: "warning",
          confirmed: "success",
          in_progress: "primary",
          completed: "success",
          cancelled: "danger",
        };
        return colors[status] || "secondary";
      }

      function getActivityIcon(status) {
        const icons = {
          completed: "check",
          scheduled: "clock",
          pending: "hourglass-half",
        };
        return icons[status] || "circle";
      }

      function getActivityColor(status) {
        const colors = {
          completed: "success",
          scheduled: "warning",
          pending: "secondary",
        };
        return colors[status] || "muted";
      }

      function formatSkillName(skill) {
        return skill
          .replace(/_/g, " ")
          .replace(/\b\w/g, (l) => l.toUpperCase());
      }

      // Job action functions
      async function acceptJob(jobId) {
        const token = localStorage.getItem("access_token");
        if (!token) {
          alert("Please sign in to accept jobs.");
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:8001/api/technician/jobs/${jobId}/accept`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            alert("Job accepted successfully!");
            loadDashboardData(); // Refresh data
          } else {
            throw new Error("Failed to accept job");
          }
        } catch (error) {
          console.error("Error accepting job:", error);
          alert("Failed to accept job. Please try again.");
        }
      }

      async function declineJob(jobId) {
        const token = localStorage.getItem("access_token");
        if (!token) {
          alert("Please sign in to decline jobs.");
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:8001/api/technician/jobs/${jobId}/decline`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (response.ok) {
            alert("Job declined.");
            loadDashboardData(); // Refresh data
          } else {
            throw new Error("Failed to decline job");
          }
        } catch (error) {
          console.error("Error declining job:", error);
          alert("Failed to decline job. Please try again.");
        }
      }

      function viewJobDetails(jobId) {
        window.location.href = `technician_jobs.html?job_id=${jobId}`;
      }

      function previousJob() {
        // Implement job navigation
        console.log("Previous job");
      }

      function nextJob() {
        // Implement job navigation
        console.log("Next job");
      }

      function initializeDashboard() {
        // Initialize any additional dashboard functionality
        console.log("Technician dashboard initialized");
      }
    </script>
  </body>
</html>
